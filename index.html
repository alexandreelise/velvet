<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Velvet</title>
    <style>
			body {
				background : black;
				color      : #cccccc;
			}

			.velvet__canvas--2:first-of-type {
				background              : url("https://alexapi.cloud/images/alexapi-wallpaper.png") no-repeat 0 0 fixed;
				background-size         : cover;
				-moz-background-size    : cover;
				-webkit-background-size : cover;
				-o-background-size      : cover;
			}

			video {
				filter : hue-rotate(45deg);
			}
    </style>
</head>
<body>
<article class="velvet">
    <figure>
        <video class="velvet__video" src="" controls>Your browser doesn't support video tag.</video>
        <canvas class="velvet__canvas--1" width="1280" height="720"></canvas>
        <canvas class="velvet__canvas--2" width="320" height="180"></canvas>
        <figcaption>
            <button class="velvet__video--play">Play Video</button>
        </figcaption>
    </figure>
    <p class="velvet__output"></p>
</article>
<script>
    function processWithVelvet () {
        return function (currentVideo, ctx1, ctx2) {

            ctx1.drawImage(currentVideo, 0, 0, currentVideo.videoWidth, currentVideo.videoHeight);
            let frame = ctx1.getImageData(0, 0, currentVideo.videoWidth, currentVideo.videoHeight);
            let l = frame.data.length / 4;

            for (let i = 0; i < l; i++) {
                let r = frame.data[i * 4 + 0];
                let g = frame.data[i * 4 + 1];
                let b = frame.data[i * 4 + 2];
                if (g > 100 && r > 100 && b < 43)
                    frame.data[i * 4 + 3] = 0;
            }
            ctx2.putImageData(frame, 0, 0);
            requestAnimationFrame(function () {
                return processWithVelvet()(currentVideo, ctx1, ctx2);
            });
        };
    }

    function activateVideo () {

        // Prefer camera resolution nearest to 1280x720.
        const constraints = { audio: false, video: { width: 1280, height: 720 } };
        navigator.mediaDevices.getUserMedia(constraints)
            .then(
                function (mediaStream) {
                    const video = document.querySelector(".velvet__video");
                    const velvetCanvas1 = document.querySelector(".velvet__canvas--1");
                    const velvetCanvas2 = document.querySelector(".velvet__canvas--2");
                    const output = document.querySelector(".velvet__output");
                    let ctx1 = velvetCanvas1.getContext("2d");
                    let ctx2 = velvetCanvas2.getContext("2d");

                    output.innerText = "Please wait.";
                    video.srcObject = mediaStream;

                    video.onloadeddata = function () {
                        velvetCanvas1.width = video.videoWidth;
                        velvetCanvas1.height = video.videoHeight;

                        velvetCanvas2.width = video.videoWidth / 4;
                        velvetCanvas2.height = video.videoHeight / 4;
                    };

                    video.onloadedmetadata = function () {
                        video.play();
                    };

                    video.onplay = function () {
                        requestAnimationFrame(function () {
                            return processWithVelvet()(video, ctx1, ctx2);
                        });
                    };
                })
            .catch((err) => {
                    throw err;
                }
            ); // always check for errors at the end.
    }

    window.addEventListener("DOMContentLoaded", function () {
        document.querySelector(".velvet__video--play").addEventListener("click", function (eventClickPlayVideo) {
            eventClickPlayVideo.preventDefault();
            eventClickPlayVideo.stopPropagation();
            try {
                activateVideo();
            } catch (exception) {
                console.error(exception);
            }
        }, false);
    }, false);
</script>
</body>
</html>
